<!doctype html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>PWAæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ - kenji-codelab</title>
        <style>
            body {
                font-family: system-ui, sans-serif;
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
            }
            .status-ok {
                color: green;
            }
            .status-error {
                color: red;
            }
            .status-warning {
                color: orange;
            }
            .test-section {
                margin: 20px 0;
                padding: 15px;
                border: 1px solid #ddd;
                border-radius: 8px;
            }
            button {
                padding: 10px 15px;
                margin: 5px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }
            .btn-primary {
                background: #007bff;
                color: white;
            }
            .btn-secondary {
                background: #6c757d;
                color: white;
            }
            #results {
                white-space: pre-wrap;
                background: #f8f9fa;
                padding: 15px;
                border-radius: 4px;
                font-family: monospace;
            }
        </style>
    </head>
    <body>
        <h1>ğŸ” PWAæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ - Serwistç‰ˆ</h1>

        <div class="test-section">
            <h2>1. Service WorkerçŠ¶æ…‹</h2>
            <div id="sw-status"></div>
            <button class="btn-primary" onclick="checkServiceWorker()">Service Workerç¢ºèª</button>
        </div>

        <div class="test-section">
            <h2>2. ã‚­ãƒ£ãƒƒã‚·ãƒ¥çŠ¶æ…‹</h2>
            <div id="cache-status"></div>
            <button class="btn-primary" onclick="checkCaches()">ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèª</button>
            <button class="btn-secondary" onclick="listCacheContents()">ã‚­ãƒ£ãƒƒã‚·ãƒ¥å†…å®¹è©³ç´°</button>
        </div>

        <div class="test-section">
            <h2>3. ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</h2>
            <div id="offline-status"></div>
            <p>ğŸ“ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹: <span id="network-status"></span></p>
            <button class="btn-primary" onclick="testOfflineResources()">
                ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒªã‚½ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ
            </button>
            <p>
                <small
                    >â€» Chrome
                    DevToolsã®Networkã‚¿ãƒ–ã§ã€ŒOfflineã€ã«ãƒã‚§ãƒƒã‚¯ã—ã¦ã‹ã‚‰ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„</small
                >
            </p>
        </div>

        <div class="test-section">
            <h2>4. åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆçµæœ</h2>
            <button class="btn-primary" onclick="runComprehensiveTest()">å…¨ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
            <pre id="results"></pre>
        </div>

        <script>
            // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹ã®ç›£è¦–
            function updateNetworkStatus() {
                const status = navigator.onLine ? 'ğŸŒ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³' : 'ğŸ“´ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³';
                document.getElementById('network-status').textContent = status;
            }

            window.addEventListener('online', updateNetworkStatus);
            window.addEventListener('offline', updateNetworkStatus);
            updateNetworkStatus();

            // Service Workerç¢ºèª
            async function checkServiceWorker() {
                const statusDiv = document.getElementById('sw-status');

                if (!('serviceWorker' in navigator)) {
                    statusDiv.innerHTML =
                        '<p class="status-error">âŒ Service Workeréå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã§ã™</p>';
                    return;
                }

                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    if (registration) {
                        const state = registration.active?.state || 'unknown';
                        statusDiv.innerHTML = `
                        <p class="status-ok">âœ… Service Workerç™»éŒ²æ¸ˆã¿</p>
                        <p>ã‚¹ã‚³ãƒ¼ãƒ—: ${registration.scope}</p>
                        <p>çŠ¶æ…‹: ${state}</p>
                        <p>ã‚¹ã‚¯ãƒªãƒ—ãƒˆURL: ${registration.active?.scriptURL || 'N/A'}</p>
                    `;
                    } else {
                        statusDiv.innerHTML = '<p class="status-error">âŒ Service Workeræœªç™»éŒ²</p>';
                    }
                } catch (error) {
                    statusDiv.innerHTML = `<p class="status-error">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
                }
            }

            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèª
            async function checkCaches() {
                const statusDiv = document.getElementById('cache-status');

                try {
                    const cacheNames = await caches.keys();
                    if (cacheNames.length > 0) {
                        const serwistCaches = cacheNames.filter(
                            name =>
                                name.includes('serwist') ||
                                [
                                    'images',
                                    'article-images',
                                    'fonts',
                                    'pages',
                                    'api-cache',
                                    'article-content',
                                ].includes(name),
                        );

                        statusDiv.innerHTML = `
                        <p class="status-ok">âœ… ${cacheNames.length}å€‹ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒåˆ©ç”¨å¯èƒ½</p>
                        <p>Serwisté–¢é€£: ${serwistCaches.length}å€‹</p>
                        <ul>${cacheNames.map(name => `<li>${name}</li>`).join('')}</ul>
                    `;
                    } else {
                        statusDiv.innerHTML =
                            '<p class="status-warning">âš ï¸ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>';
                    }
                } catch (error) {
                    statusDiv.innerHTML = `<p class="status-error">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
                }
            }

            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥å†…å®¹è©³ç´°
            async function listCacheContents() {
                try {
                    const cacheNames = await caches.keys();
                    let content = 'ã‚­ãƒ£ãƒƒã‚·ãƒ¥å†…å®¹è©³ç´°:\n\n';

                    for (const cacheName of cacheNames) {
                        const cache = await caches.open(cacheName);
                        const keys = await cache.keys();
                        content += `ğŸ“ ${cacheName} (${keys.length}ä»¶)\n`;
                        content += keys
                            .slice(0, 5)
                            .map(req => `  - ${req.url}`)
                            .join('\n');
                        if (keys.length > 5) content += `\n  ... ä»–${keys.length - 5}ä»¶`;
                        content += '\n\n';
                    }

                    document.getElementById('results').textContent = content;
                } catch (error) {
                    document.getElementById('results').textContent = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                }
            }

            // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒªã‚½ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ
            async function testOfflineResources() {
                const statusDiv = document.getElementById('offline-status');
                const testUrls = [
                    '/',
                    '/books',
                    '/books/p5_tutorial/1-0',
                    '/books/p5_tutorial/images/1-0/1.png',
                    '/_next/static/chunks/framework-b9bc70a31e6f8a8a.js',
                ];

                let results = 'ğŸ§ª ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒªã‚½ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆçµæœ:\n\n';

                for (const url of testUrls) {
                    try {
                        const cachedResponse = await caches.match(url);
                        const status = cachedResponse ? 'âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿' : 'âŒ æœªã‚­ãƒ£ãƒƒã‚·ãƒ¥';
                        results += `${status} ${url}\n`;
                    } catch (error) {
                        results += `âŒ ã‚¨ãƒ©ãƒ¼ ${url}: ${error.message}\n`;
                    }
                }

                statusDiv.innerHTML = `<pre>${results}</pre>`;
            }

            // åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆ
            async function runComprehensiveTest() {
                const results = document.getElementById('results');
                results.textContent = 'ğŸ” åŒ…æ‹¬çš„PWAãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...\n\n';

                let report = '';

                // 1. Service Workerç¢ºèª
                report += '=== Service Worker ===\n';
                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    report += registration ? 'âœ… ç™»éŒ²æ¸ˆã¿\n' : 'âŒ æœªç™»éŒ²\n';
                    if (registration) {
                        report += `   çŠ¶æ…‹: ${registration.active?.state}\n`;
                        report += `   ã‚¹ã‚³ãƒ¼ãƒ—: ${registration.scope}\n`;
                    }
                } catch (error) {
                    report += `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}\n`;
                }

                // 2. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèª
                report += '\n=== ã‚­ãƒ£ãƒƒã‚·ãƒ¥ ===\n';
                try {
                    const cacheNames = await caches.keys();
                    report += `ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ•°: ${cacheNames.length}\n`;

                    const expectedCaches = [
                        'images',
                        'article-images',
                        'fonts',
                        'pages',
                        'api-cache',
                        'article-content',
                        'static-assets',
                    ];
                    for (const expected of expectedCaches) {
                        const exists = cacheNames.some(name => name.includes(expected));
                        report += `${exists ? 'âœ…' : 'âŒ'} ${expected}\n`;
                    }

                    // ãƒ—ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèª
                    const precacheNames = cacheNames.filter(name => name.includes('precache'));
                    if (precacheNames.length > 0) {
                        const cache = await caches.open(precacheNames[0]);
                        const keys = await cache.keys();
                        report += `âœ… ãƒ—ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥: ${keys.length}ä»¶\n`;
                    }
                } catch (error) {
                    report += `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}\n`;
                }

                // 3. é‡è¦ãƒªã‚½ãƒ¼ã‚¹ã®ç¢ºèª
                report += '\n=== é‡è¦ãƒªã‚½ãƒ¼ã‚¹ ===\n';
                const criticalUrls = ['/', '/books', '/sw.js', '/manifest.json'];

                for (const url of criticalUrls) {
                    try {
                        const response = await caches.match(url);
                        report += `${response ? 'âœ…' : 'âŒ'} ${url}\n`;
                    } catch (error) {
                        report += `âŒ ${url}: ${error.message}\n`;
                    }
                }

                // 4. ç·åˆè©•ä¾¡
                report += '\n=== ç·åˆè©•ä¾¡ ===\n';
                const registration = await navigator.serviceWorker.getRegistration();
                const cacheNames = await caches.keys();
                const hasPrecache = cacheNames.some(name => name.includes('precache'));

                if (registration && cacheNames.length > 0 && hasPrecache) {
                    report += 'ğŸ‰ PWAæ©Ÿèƒ½ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ï¼\n';
                    report += 'âœ… ã‚ªãƒ•ãƒ©ã‚¤ãƒ³é–²è¦§ãŒå¯èƒ½ã§ã™\n';
                } else {
                    report += 'âš ï¸ ä¸€éƒ¨æ©Ÿèƒ½ã«å•é¡ŒãŒã‚ã‚Šã¾ã™\n';
                    if (!registration) report += '- Service Workeræœªç™»éŒ²\n';
                    if (cacheNames.length === 0) report += '- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—\n';
                    if (!hasPrecache) report += '- ãƒ—ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—\n';
                }

                results.textContent = report;
            }

            // åˆæœŸåŒ–
            document.addEventListener('DOMContentLoaded', () => {
                checkServiceWorker();
                checkCaches();
            });
        </script>
    </body>
</html>
